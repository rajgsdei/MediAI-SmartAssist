{% extends 'base.html' %}

{% block content %}

{% block extra_css %}

<style>
    .chat-container {
        max-height: 500px;
        overflow-y: auto;
    }
    .chat-messages {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        min-height: 300px;
        background-color: #f9f9f9;
    }
    .message {
        margin-bottom: 10px;
    }
    .user-message {
        text-align: right;
        color: #007bff;
    }
    .ai-message {
        text-align: left;
        color: #28a745;
    }
</style>

{% endblock %}
<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h3>Medi-AI Assistant</h3>
        </div>
        <div class="card-body">
            <div id="chat-container" class="chat-container">
                <div id="chat-messages" class="chat-messages">
                    <!-- Chat messages will appear here -->
                </div>
                <div class="chat-input mt-3">
                    <form id="chat-form">
                        <div class="input-group">
                            <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." autocomplete="off">
                            <button type="submit" class="btn btn-primary">Send</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        const chatForm = $('#chat-form');
        const chatInput = $('#chat-input');
        const chatMessages = $('#chat-messages');

        chatForm.on('submit', function(e) {
            
            e.preventDefault();
            const userMessage = chatInput.val().trim();
            if (userMessage) {
                // Append user message to chat
                chatMessages.append(`<div class="message user-message">${userMessage}</div>`);
                chatInput.val('');

                // Send the message to the backend API
                $.ajax({
                    url: '{% url "ai_chat" %}',
                    method: 'POST',
                    data: {
                        message: userMessage,
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    success: function(response) {
                        if (response.success) {
                            if (response.data) {
                                // Display any list of objects (generic)
                                let html = '<div class="message ai-message">Here are the results:</div>';
                                response.data.forEach(item => {
                                    html += '<div class="message ai-message">';
                                    for (const [key, value] of Object.entries(item)) {
                                        html += `<strong>${key}:</strong> ${value}<br>`;
                                    }
                                    html += '</div>';
                                });
                                chatMessages.append(html);
                            } else if (response.message) {
                                chatMessages.append(`<div class="message ai-message">${response.message}</div>`);
                            } else {
                                chatMessages.append(`<div class="message ai-message">No results found.</div>`);
                            }
                        } else {
                            chatMessages.append(`<div class="message ai-message">Error: ${response.error}</div>`);
                        }
                        chatMessages.scrollTop(chatMessages[0].scrollHeight);
                    },
                    error: function(e) {
                        debugger
                        chatMessages.append(`<div class="message ai-message">An error occurred. Please try again.</div>`+e.message);
                        chatMessages.scrollTop(chatMessages[0].scrollHeight);
                    }
                });
            }
        });
    });
</script>
{% endblock %}